<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"manual","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="我于人间全无敌，不与天战与shui战？本文测试数据和Explain可视化工具资料包链接：https:&#x2F;&#x2F;pan.baidu.com&#x2F;s&#x2F;1Q8Zt7gWBF6JkW_Kg6sIWzw提取码：2khx      相关学习文档链接：https:&#x2F;&#x2F;pan.baidu.com&#x2F;s&#x2F;1Wdc2f38csrGbC3GA1s0H_w提取码：888i    永久有效，失效来打我~ Hive on mr   即H">
<meta property="og:type" content="article">
<meta property="og:title" content="Hive on mr调优">
<meta property="og:url" content="http://example.com/2023/07/31/Hive-on-mr/index.html">
<meta property="og:site_name" content="第五门徒">
<meta property="og:description" content="我于人间全无敌，不与天战与shui战？本文测试数据和Explain可视化工具资料包链接：https:&#x2F;&#x2F;pan.baidu.com&#x2F;s&#x2F;1Q8Zt7gWBF6JkW_Kg6sIWzw提取码：2khx      相关学习文档链接：https:&#x2F;&#x2F;pan.baidu.com&#x2F;s&#x2F;1Wdc2f38csrGbC3GA1s0H_w提取码：888i    永久有效，失效来打我~ Hive on mr   即H">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2023/07/31/Hive-on-mr/1.gif">
<meta property="og:image" content="http://example.com/2023/07/31/Hive-on-mr/1.png">
<meta property="og:image" content="http://example.com/2023/07/31/Hive-on-mr/2.png">
<meta property="og:image" content="http://example.com/2023/07/31/Hive-on-mr/3.png">
<meta property="og:image" content="http://example.com/2023/07/31/Hive-on-mr/4.png">
<meta property="og:image" content="http://example.com/2023/07/31/Hive-on-mr/5.png">
<meta property="og:image" content="http://example.com/2023/07/31/Hive-on-mr/6.png">
<meta property="og:image" content="http://example.com/2023/07/31/Hive-on-mr/7.png">
<meta property="og:image" content="http://example.com/2023/07/31/Hive-on-mr/8.png">
<meta property="og:image" content="http://example.com/2023/07/31/Hive-on-mr/9.png">
<meta property="og:image" content="http://example.com/2023/07/31/Hive-on-mr/10.png">
<meta property="og:image" content="http://example.com/2023/07/31/Hive-on-mr/11.png">
<meta property="og:image" content="http://example.com/2023/07/31/Hive-on-mr/12.png">
<meta property="og:image" content="http://example.com/2023/07/31/Hive-on-mr/13.png">
<meta property="og:image" content="http://example.com/2023/07/31/Hive-on-mr/14.png">
<meta property="og:image" content="http://example.com/2023/07/31/Hive-on-mr/15.png">
<meta property="og:image" content="http://example.com/2023/07/31/Hive-on-mr/16.png">
<meta property="og:image" content="http://example.com/2023/07/31/Hive-on-mr/17.png">
<meta property="og:image" content="http://example.com/2023/07/31/Hive-on-mr/18.png">
<meta property="og:image" content="http://example.com/2023/07/31/Hive-on-mr/19.png">
<meta property="og:image" content="http://example.com/2023/07/31/Hive-on-mr/20.png">
<meta property="og:image" content="http://example.com/2023/07/31/Hive-on-mr/21.png">
<meta property="article:published_time" content="2023-07-31T07:57:39.000Z">
<meta property="article:modified_time" content="2023-08-11T05:05:08.373Z">
<meta property="article:author" content="张宴银">
<meta property="article:tag" content="我于人间全无敌，不与天战与谁战？">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2023/07/31/Hive-on-mr/1.gif">

<link rel="canonical" href="http://example.com/2023/07/31/Hive-on-mr/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Hive on mr调优 | 第五门徒</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/rss2.xml" title="第五门徒" type="application/rss+xml">
</head>




<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">第五门徒</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="calendar fa-fw"></i>日程表</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="sitemap fa-fw"></i>站点地图</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404/" rel="section"><i class="heartbeat fa-fw"></i>公益 404</a>

  </li>
        <li class="menu-item menu-item-resources">

    <a href="/resources/" rel="section"><i class="download fa-fw"></i>资源</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/07/31/Hive-on-mr/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="张宴银">
      <meta itemprop="description" content="初级以内我无敌，中级以上我一换一">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="第五门徒">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Hive on mr调优
        </h1>

        <div class="post-meta">
		  
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-07-31 15:57:39" itemprop="dateCreated datePublished" datetime="2023-07-31T15:57:39+08:00">2023-07-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-08-11 13:05:08" itemprop="dateModified" datetime="2023-08-11T13:05:08+08:00">2023-08-11</time>
              </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="我于人间全无敌，不与天战与shui战？"><a href="#我于人间全无敌，不与天战与shui战？" class="headerlink" title="我于人间全无敌，不与天战与shui战？"></a>我于人间全无敌，不与天战与shui战？</h1><p>本文测试数据和Explain可视化工具资料包<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1Q8Zt7gWBF6JkW_Kg6sIWzw">https://pan.baidu.com/s/1Q8Zt7gWBF6JkW_Kg6sIWzw</a><br>提取码：2khx     </p>
<p>相关学习文档<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1Wdc2f38csrGbC3GA1s0H_w">https://pan.baidu.com/s/1Wdc2f38csrGbC3GA1s0H_w</a><br>提取码：888i   </p>
<p>永久有效，失效来打我~<br><img src="/2023/07/31/Hive-on-mr/1.gif"></p>
<p>Hive on mr  </p>
<p>即Hive引擎选用mapreduce。（目前Hive引擎可选项为Mapreduce&#x2F;Tez&#x2F;Spark）  </p>
<p>调优主要分为下面三个方向 </p>
<p>1)：组件资源调优  </p>
<p>通过控制任务运行的组件资源，实现任务的高效运行</p>
<p>2)：Explain执行计划调优  </p>
<p>通过优化执行计划,保证相同资源配置的情况下，任务运行更流畅  </p>
<p>3): 常有调优参数设置  </p>
<p>开启Hive内置的一些有助于任务高效运行的设置,保障任务流畅运行  </p>
<h2 id="1-组件资源调优"><a href="#1-组件资源调优" class="headerlink" title="1:组件资源调优"></a>1:组件资源调优</h2><h3 id="Yarn资源配置"><a href="#Yarn资源配置" class="headerlink" title="Yarn资源配置"></a>Yarn资源配置</h3><p>需要调整的Yarn参数均与CPU、内存等资源有关，核心配置参数如下  </p>
<p>（1）yarn.nodemanager.resource.memory-mb  </p>
<p>该参数的含义是，一个NodeManager节点分配给Container使用的内存。该参数的配置，<strong>取决于NodeManager所在节点的总内存容量和该节点运行的其他服务的数量</strong>。  </p>
<p>（2）yarn.nodemanager.resource.cpu-vcores  </p>
<p>该参数的含义是，一个NodeManager节点分配给Container使用的CPU核数。该参数的配置，<strong>同样取决于NodeManager所在节点的总CPU核数和该节点运行的其他服务</strong>。</p>
<p>通常是一个核4个G  </p>
<pre><code>即（1）yarn.nodemanager.resource.memory-mb/（2）yarn.nodemanager.resource.cpu-vcores  = 4  
</code></pre>
<p>（3）yarn.scheduler.maximum-allocation-mb  </p>
<p>该参数的含义是，单个Container能够使用的最大内存</p>
<pre><code>（1）yarn.nodemanager.resource.memory-mb /（3）yarn.scheduler.maximum-allocation-mb  = 整数
</code></pre>
<p>（4）yarn.scheduler.minimum-allocation-mb  </p>
<p>该参数的含义是，单个Container能够使用的最小内存，推荐配置(512M)如下：  </p>
<pre><code>&lt;property&gt;
    &lt;name&gt;yarn.scheduler.minimum-allocation-mb&lt;/name&gt;
    &lt;value&gt;512&lt;/value&gt;
&lt;/property&gt;
</code></pre>
<h3 id="MapReduce资源配置"><a href="#MapReduce资源配置" class="headerlink" title="MapReduce资源配置"></a>MapReduce资源配置</h3><p>MapReduce资源配置主要包括Map Task的内存和CPU核数，以及Reduce Task的内存和CPU核数  </p>
<p>1）mapreduce.map.memory.mb	  </p>
<p>该参数的含义是，单个Map Task申请的container容器内存大小，其默认值为1024。该值不能超出yarn.scheduler.maximum-allocation-mb和yarn.scheduler.minimum-allocation-mb规定的范围  </p>
<p>该参数需要根据不同的计算任务单独进行配置，在hive中，可直接使用如下方式为每个SQL语句单独进行配置： </p>
<pre><code>set  mapreduce.map.memory.mb=2048;  
</code></pre>
<p>2）mapreduce.map.cpu.vcores  </p>
<p>该参数的含义是，单个Map Task申请的container容器cpu核数，其默认值为1。该值一般无需调整</p>
<p>3）mapreduce.reduce.memory.mb	</p>
<p>该参数的含义是，单个Reduce Task申请的container容器内存大小，其默认值为1024。该值同样不能超出yarn.scheduler.maximum-allocation-mb和yarn.scheduler.minimum-allocation-mb规定的范围  </p>
<p>该参数需要根据不同的计算任务单独进行配置，在hive中，可直接使用如下方式为每个SQL语句单独进行配置  </p>
<pre><code>set  mapreduce.reduce.memory.mb=2048;  
</code></pre>
<p>4）mapreduce.reduce.cpu.vcores	  </p>
<p>该参数的含义是，单个Reduce Task申请的container容器cpu核数，其默认值为1。该值一般无需调整  </p>
<h1 id="2-Explain执行计划调优"><a href="#2-Explain执行计划调优" class="headerlink" title="2.Explain执行计划调优"></a>2.Explain执行计划调优</h1><h2 id="测试用表"><a href="#测试用表" class="headerlink" title="测试用表"></a>测试用表</h2><h3 id="1-订单表-2000w条数据"><a href="#1-订单表-2000w条数据" class="headerlink" title="1.订单表(2000w条数据)"></a>1.订单表(2000w条数据)</h3><h4 id="建表语句"><a href="#建表语句" class="headerlink" title="建表语句"></a>建表语句</h4><pre><code>hive (default)&gt;
drop table if exists order_detail;
create table order_detail(
id           string comment &#39;订单id&#39;,
user_id      string comment &#39;用户id&#39;,
product_id   string comment &#39;商品id&#39;,
province_id  string comment &#39;省份id&#39;,
create_time  string comment &#39;下单时间&#39;,
product_num  int comment &#39;商品件数&#39;,
total_amount decimal(16, 2) comment &#39;下单金额&#39;
)
partitioned by (dt string)
row format delimited fields terminated by &#39;\t&#39;;
</code></pre>
<h4 id="数据装载"><a href="#数据装载" class="headerlink" title="数据装载"></a>数据装载</h4><p>将order_detail.txt文件上传到hiveserver2所在节点的&#x2F;opt&#x2F;module&#x2F;hive&#x2F;datas&#x2F;目录，并执行以下导入语句。</p>
<p>注：文件较大，请耐心等待。  </p>
<pre><code>hive (default)&gt; 
load data local inpath &#39;/opt/module/hive/datas/order_detail.txt&#39; overwrite into table order_detail partition(dt=&#39;2020-06-14&#39;); 
</code></pre>
<h3 id="2-支付表-600w条数据"><a href="#2-支付表-600w条数据" class="headerlink" title="2.支付表(600w条数据)"></a>2.支付表(600w条数据)</h3><h4 id="建表语句-1"><a href="#建表语句-1" class="headerlink" title="建表语句"></a>建表语句</h4><pre><code>hive (default)&gt;
drop table if exists payment_detail;
create table payment_detail(
id              string comment &#39;支付id&#39;,
order_detail_id string comment &#39;订单明细id&#39;,
user_id         string comment &#39;用户id&#39;,
payment_time    string comment &#39;支付时间&#39;,
total_amount    decimal(16, 2) comment &#39;支付金额&#39;
)
partitioned by (dt string)
row format delimited fields terminated by &#39;\t&#39;;
</code></pre>
<h4 id="数据装载-1"><a href="#数据装载-1" class="headerlink" title="数据装载"></a>数据装载</h4><p>将payment_detail.txt文件上传到HiveServer2所在节点的&#x2F;opt&#x2F;module&#x2F;hive&#x2F;datas&#x2F;目录，并执行以下导入语句。</p>
<p>注：文件较大，请耐心等待。  </p>
<pre><code>hive (default)&gt; 
load data local inpath &#39;/opt/module/hive/datas/payment_detail.txt&#39; overwrite into table payment_detail partition(dt=&#39;2020-06-14&#39;);  
</code></pre>
<h3 id="3-商品信息表-100w条数据"><a href="#3-商品信息表-100w条数据" class="headerlink" title="3.商品信息表(100w条数据)"></a>3.商品信息表(100w条数据)</h3><h4 id="建表语句-2"><a href="#建表语句-2" class="headerlink" title="建表语句"></a>建表语句</h4><pre><code>hive (default)&gt; 
drop table if exists product_info;
create table product_info(
id           string comment &#39;商品id&#39;,
product_name string comment &#39;商品名称&#39;,
price        decimal(16, 2) comment &#39;价格&#39;,
category_id  string comment &#39;分类id&#39;
)
row format delimited fields terminated by &#39;\t&#39;;  
</code></pre>
<h4 id="数据装载-2"><a href="#数据装载-2" class="headerlink" title="数据装载"></a>数据装载</h4><p>将product_info.txt文件上传到HiveServer2所在节点的&#x2F;opt&#x2F;module&#x2F;hive&#x2F;datas&#x2F;目录，并执行以下导入语句。  </p>
<pre><code>hive (default)&gt; 
load data local inpath &#39;/opt/module/hive/datas/product_info.txt&#39; overwrite into table product_info;  
</code></pre>
<h3 id="4-省份信息表-34条数据"><a href="#4-省份信息表-34条数据" class="headerlink" title="4.省份信息表(34条数据)"></a>4.省份信息表(34条数据)</h3><h4 id="建表语句-3"><a href="#建表语句-3" class="headerlink" title="建表语句"></a>建表语句</h4><pre><code>hive (default)&gt; 
drop table if exists province_info;
create table province_info(
id            string comment &#39;省份id&#39;,
province_name string comment &#39;省份名称&#39;
)
row format delimited fields terminated by &#39;\t&#39;;  
</code></pre>
<h4 id="数据装载-3"><a href="#数据装载-3" class="headerlink" title="数据装载"></a>数据装载</h4><p>将province_info.txt文件上传到HiveServer2所在节点的&#x2F;opt&#x2F;module&#x2F;hive&#x2F;datas&#x2F;目录，并执行以下导入语句。  </p>
<pre><code>hive (default)&gt; 
load data local inpath &#39;/opt/module/hive/datas/province_info.txt&#39; overwrite into table province_info;  
</code></pre>
<h2 id="Explain查看执行计划（重点）"><a href="#Explain查看执行计划（重点）" class="headerlink" title="Explain查看执行计划（重点）"></a>Explain查看执行计划（重点）</h2><p>Explain呈现的执行计划，由一系列Stage组成，这一系列Stage具有依赖关系，每个Stage对应一个MapReduce Job，或者一个文件系统操作等。  </p>
<p>若某个Stage对应的一个MapReduce Job，其Map端和Reduce端的计算逻辑分别由Map Operator Tree和Reduce Operator Tree进行描述，Operator Tree由一系列的Operator组成，一个Operator代表在Map或Reduce阶段的一个单一的逻辑操作，例如TableScan Operator，Select Operator，Join Operator等</p>
<h3 id="常见的Operator及其作用如下："><a href="#常见的Operator及其作用如下：" class="headerlink" title="常见的Operator及其作用如下："></a>常见的Operator及其作用如下：</h3><p>TableScan：表扫描操作，通常map端第一个操作肯定是表扫描操作  </p>
<p>Select Operator：选取操作   </p>
<p>Group By Operator：分组聚合操作  </p>
<p>Reduce Output Operator：输出到 reduce 操作  </p>
<p>Filter Operator：过滤操作  </p>
<p>Join Operator：join 操作  </p>
<p>File Output Operator：文件输出操作  </p>
<p>Fetch Operator 客户端获取数据操作  </p>
<h3 id="Explain查看执行计划基本语法"><a href="#Explain查看执行计划基本语法" class="headerlink" title="Explain查看执行计划基本语法"></a>Explain查看执行计划基本语法</h3><p>EXPLAIN [FORMATTED | EXTENDED | DEPENDENCY] query-sql  </p>
<pre><code>FORMATTED：将执行计划以JSON字符串的形式输出  

EXTENDED：输出执行计划中的额外信息，通常是读写的文件名等信息  

DEPENDENCY：输出执行计划读取的表及分区  
</code></pre>
<h3 id="Explain执行计划可视化工具使用方法"><a href="#Explain执行计划可视化工具使用方法" class="headerlink" title="Explain执行计划可视化工具使用方法"></a>Explain执行计划可视化工具使用方法</h3><p>1.将本文开头百度网盘共享的dist文件压缩包上传至linux服务器中  </p>
<p>2.unzip dist.zip 解压  </p>
<p>3.进入解压后的dist文件夹下  </p>
<p>4.python -m SimpleHTTPServer 8901  启动可视化工具（此处的8901是我指定的可用端口号，可以按自己的想法设置）<br><img src="/2023/07/31/Hive-on-mr/1.png" alt="Explain可视化工具">  </p>
<p>5.将Explain执行计划制作成json格式粘贴到可视化工具里即可查看  </p>
<p><img src="/2023/07/31/Hive-on-mr/2.png" alt="Explain执行计划json格式">  </p>
<p>6.Explain可视化工具示例  </p>
<p><img src="/2023/07/31/Hive-on-mr/3.png" alt="示例">  </p>
<h2 id="HQL语法优化之分组聚合优化-（map-site）"><a href="#HQL语法优化之分组聚合优化-（map-site）" class="headerlink" title="HQL语法优化之分组聚合优化 （map-site）"></a>HQL语法优化之分组聚合优化 （map-site）</h2><p>Hive对分组聚合的优化主要围绕着减少Shuffle数据量进行，具体做法是map-side聚合  </p>
<p>在map端维护一个hash table进行预聚合，按照分组字段分区，发送至reduce端，完成最终的聚合。有效的减少shuffle操作的数量，达到提高运行效率的目的。  </p>
<h3 id="map-side-聚合相关的参数如下："><a href="#map-side-聚合相关的参数如下：" class="headerlink" title="map-side 聚合相关的参数如下："></a>map-side 聚合相关的参数如下：</h3><p>–启用map-side聚合 </p>
<pre><code>set hive.map.aggr=true;  
</code></pre>
<p>–用于检测源表数据是否适合进行map-side聚合。检测的方法是：先对若干条数据进行map-side聚合，若聚合后的条数和聚合前的条数比值小于该值，则认为该表适合进行map-side聚合；否则，认为该表数据不适合进行map-side聚合，后续数据便不再进行map-side聚合。  </p>
<pre><code>set hive.map.aggr.hash.min.reduction=0.5;  
</code></pre>
<p>–用于检测源表是否适合map-side聚合的条数  </p>
<pre><code>set hive.groupby.mapaggr.checkinterval=100000;  
</code></pre>
<p>–map-side聚合所用的hash table，占用map task堆内存的最大比例，若超出该值，则会对hash table进行一次flush。  </p>
<pre><code>set hive.map.aggr.hash.force.flush.memory.threshold=0.9;  
</code></pre>
<h3 id="HQL语法优化之分组聚合优化-（map-site）优化案例"><a href="#HQL语法优化之分组聚合优化-（map-site）优化案例" class="headerlink" title="HQL语法优化之分组聚合优化 （map-site）优化案例"></a>HQL语法优化之分组聚合优化 （map-site）优化案例</h3><pre><code>select
product_id,
count(*)
from order_detail
group by product_id;  
</code></pre>
<p><img src="/2023/07/31/Hive-on-mr/4.png" alt="启用map-site调优前后Explain执行计划对比">  </p>
<h4 id="优化思路"><a href="#优化思路" class="headerlink" title="优化思路"></a>优化思路</h4><p>开启map-side聚合，配置以下参数：  </p>
<pre><code>set hive.map.aggr=true;  

set hive.map.aggr.hash.min.reduction=0.5;   

set hive.groupby.mapaggr.checkinterval=100000;  

set hive.map.aggr.hash.force.flush.memory.threshold=0.9;  
</code></pre>
<h3 id="HQL语法优化之Join优化"><a href="#HQL语法优化之Join优化" class="headerlink" title="HQL语法优化之Join优化"></a>HQL语法优化之Join优化</h3><p>Join算法概述</p>
<p>Common Join : 常规join，不做优化    </p>
<p><img src="/2023/07/31/Hive-on-mr/5.png" alt="Common Join原理图">  </p>
<p>Map Join：<strong>适用于大表join小表</strong>，将小表数据缓存为hash table（内存表），然后扫描大表数据，这样在map端即可完成关联操作  </p>
<p><img src="/2023/07/31/Hive-on-mr/6.png" alt="Map Join原理图"></p>
<p>Bucket Map Join：<strong>适用于大表join大表</strong>  通过分桶对数据进行切分，让有限的内存缓存一部分分桶数据，再对另一个大表进行遍历操作     </p>
<pre><code> Bucket Map Join的使用要求：若能保证参与**join的表均为分桶表，且关联字段为分桶字段，且其中一张表的分桶数量是另外一张表分桶数量的整数倍**
</code></pre>
<p><img src="/2023/07/31/Hive-on-mr/7.png" alt="Bucket Map Join原理图"></p>
<p>SMB Map Join：<strong>适用于大表join大表</strong>，两个分桶之间的join实现原理为Sort Merge Join算法。前提条件是两个大表分桶数据都要排好序，这样就无需缓存在内存中，通过Sort Merge Join算法直接完成逐条遍历计算。  </p>
<pre><code>SMB Map Join的使用要求:参与join的表均为分桶表，且需保证分桶内的数据是有序的，且分桶字段、排序字段和关联字段为相同字段，且其中一张表的分桶数量是另外一张表分桶数量的整数倍    
</code></pre>
<p><img src="/2023/07/31/Hive-on-mr/8.png" alt="SMB Map Join原理图"></p>
<p>Bucket Map Join 和 SMB Map Join 的区别：  </p>
<p>1.SMB Map Join在Bucket Map join的基础上，要求分桶内的数据是有序的，且分桶字段、排序字段和关联字段为相同字段</p>
<p>2.两个分桶之间的join实现算法不一样  </p>
<pre><code>Bucket Map Join，两个分桶之间的join实现原理为Hash Join算法    

SMB Map Join，两个分桶之间的join实现原理为Sort Merge Join算法   
</code></pre>
<p>3.相较于Bucket Map Join，SMB Map Join对分桶大小是没有要求的,因为SMB Map Join不需要缓存数据  </p>
<h4 id="Map-Join"><a href="#Map-Join" class="headerlink" title="Map Join"></a>Map Join</h4><p>优化说明 </p>
<p><img src="/2023/07/31/Hive-on-mr/9.png" alt="Map join原理解析">   </p>
<p>寻找大表候选人：  </p>
<p>a inner join b时，a,b都可以作为大表候选人，只返回a,b都能连接上的数据  </p>
<p>A Left join  b时，只有b才可以作为大表候选人，这样才会遍历A表数据，输出A的所有数据  </p>
<p>A right join b时，只有A才可以作为大表候选人，这样才会遍历B表的数据，输出B的所有数据  </p>
<p>A full join b时，没有大表候选人，因为无论选a还是B作为大表候选人，都无法输出a和b的所有数据  </p>
<p>Conditionaltask：条件任务  </p>
<p>图中涉及到的参数如下：    </p>
<p>–启动Map Join自动转换  </p>
<pre><code>set hive.auto.convert.join=true;  
</code></pre>
<p>–一个Common Join operator转为Map Join operator的判断条件,若该Common Join相关的表中,存在n-1张表的已知大小总和&lt;&#x3D;该值,则生成一个Map Join计划,此时可能存在多种n-1张表的组合均满足该条件,则hive会为每种满足条件的组合均生成一个Map Join计划,同时还会保留原有的Common Join计划作为后备(back up)计划,实际运行时,优先执行Map Join计划，若不能执行成功，则启动Common Join后备计划。 </p>
<pre><code>set hive.mapjoin.smalltable.filesize=250000;    
</code></pre>
<p>注意此处的内存大小参数与实际读取磁盘文件的大小是有差别的，考虑到磁盘文件解压缩，反序列化和对象信息，相同文件在内存中要比在磁盘中占用的空间放大大概10倍  </p>
<p>所以该参数设置为1G，就表明拿取磁盘中1G大小的文件，但内存需要占用10G  </p>
<p>实际生产中，将参数配置到hive-site等配置文件中。设置size参数时，通常配置为map端内存的1&#x2F;2 ~2&#x2F;3范围内作为缓存，记得size的值应该是map_memory*2&#x2F;3 的十分之一大小才行，否则磁盘文件读取到内存，会oom  </p>
<p>生产中，配置文件中的调优参数生效后，大部分sql语句性能提高了，如果极少部分任务还是慢sql，就需要单独调优，在语句中加入set参数的方式进行针对性局部调优  </p>
<p>–开启无条件转Map Join</p>
<pre><code>set hive.auto.convert.join.noconditionaltask=true;  
</code></pre>
<p>–无条件转Map Join时的小表之和阈值,若一个Common Join operator相关的表中，存在n-1张表的大小总和&lt;&#x3D;该值,此时hive便不会再为每种n-1张表的组合均生成Map Join计划,同时也不会保留Common Join作为后备计划。而是只生成一个最优的Map Join计划。  </p>
<pre><code>set hive.auto.convert.join.noconditionaltask.size=10000000;  
</code></pre>
<h5 id="Map-Join优化案例"><a href="#Map-Join优化案例" class="headerlink" title="Map Join优化案例"></a>Map Join优化案例</h5><pre><code>select  *
from order_detail od
join product_info product on od.product_id = product.id
join province_info province on od.province_id = province.id;  
</code></pre>
<p>优化前：设置 set hive.auto.convert.join&#x3D;true &#x3D; false  </p>
<p><img src="/2023/07/31/Hive-on-mr/10.png" alt="Map Join优化前">    </p>
<p>对参与关联的三张表进行分析，发现各自大小如下   </p>
<p><img src="/2023/07/31/Hive-on-mr/11.png" alt="参与关联的三张表大小"></p>
<h6 id="Map-Join方案一："><a href="#Map-Join方案一：" class="headerlink" title="Map Join方案一："></a>Map Join方案一：</h6><p>启用Map Join自动转换 </p>
<pre><code>set hive.auto.convert.join=true;  
</code></pre>
<p>不使用无条件转Map Join  </p>
<pre><code>set hive.auto.convert.join.noconditionaltask=false;  
</code></pre>
<p>调整hive.mapjoin.smalltable.filesize参数，使其大于等于product_info  </p>
<pre><code>set hive.mapjoin.smalltable.filesize=25285707;  
</code></pre>
<p>这样可保证将两个Common Join operator均可转为Map Join operator，并保留Common Join作为后备计划，保证计算任务的稳定  </p>
<p><img src="/2023/07/31/Hive-on-mr/12.png" alt="Map Jion优化方案一">  </p>
<h6 id="Map-Join方案二："><a href="#Map-Join方案二：" class="headerlink" title="Map Join方案二："></a>Map Join方案二：</h6><p>启用Map Join自动转换  </p>
<pre><code>set hive.auto.convert.join=true;  
</code></pre>
<p>使用无条件转Map Join  </p>
<pre><code>set hive.auto.convert.join.noconditionaltask=true;  
</code></pre>
<p>调整hive.auto.convert.join.noconditionaltask.size参数，使其大于等于product_info和province_info之和  </p>
<pre><code>set hive.auto.convert.join.noconditionaltask.size=25286076;  
</code></pre>
<p>这样可直接将两个Common Join operator转为两个Map Join operator，并且由于两个Map Join operator的小表大小之和小于等于hive.auto.convert.join.noconditionaltask.size，故两个Map Join operator任务可合并为同一个。这个方案计算效率最高，但需要的内存也是最多的</p>
<p><img src="/2023/07/31/Hive-on-mr/13.png" alt="Map Jion优化方案二"> </p>
<h6 id="Map-Join方案三："><a href="#Map-Join方案三：" class="headerlink" title="Map Join方案三："></a>Map Join方案三：</h6><p>启用Map Join自动转换    </p>
<pre><code>set hive.auto.convert.join=true;   
</code></pre>
<p>使用无条件转Map Join  </p>
<pre><code>set hive.auto.convert.join.noconditionaltask=true;    
</code></pre>
<p>调整hive.auto.convert.join.noconditionaltask.size参数，使其等于product_info</p>
<pre><code>set hive.auto.convert.join.noconditionaltask.size=25285707;  
</code></pre>
<p>这样可直接将两个Common Join operator转为Map Join operator，但不会将两个Map Join的任务合并。该方案计算效率比方案二低，但需要的内存也更少</p>
<p><img src="/2023/07/31/Hive-on-mr/14.png" alt="Map Join优化方案三"></p>
<h4 id="Bucket-Map-Join"><a href="#Bucket-Map-Join" class="headerlink" title="Bucket Map Join"></a>Bucket Map Join</h4><p>Bucket Map Join不支持自动转换，发须通过用户在SQL语句中提供如下Hint提示，并配置如下相关参数，方可使用  </p>
<pre><code>select /*+ mapjoin(ta) */
ta.id,
tb.id
from table_a ta
join table_b tb on ta.id=tb.id; 
</code></pre>
<p>相关参数  </p>
<p>–关闭cbo优化，cbo会导致hint信息被忽略  </p>
<pre><code>set hive.cbo.enable=false;
</code></pre>
<p>–map join hint默认会被忽略(因为已经过时)，需将如下参数设置为false  </p>
<pre><code>set hive.ignore.mapjoin.hint=false;  
</code></pre>
<p>–启用bucket map join优化功能  </p>
<pre><code>set hive.optimize.bucketmapjoin = true;    
</code></pre>
<h5 id="Bucket-Map-Join优化案例"><a href="#Bucket-Map-Join优化案例" class="headerlink" title="Bucket Map Join优化案例"></a>Bucket Map Join优化案例</h5><pre><code>select
    *
from(
    select
        *
    from order_detail
    where dt=&#39;2020-06-14&#39;
)od
join(
    select
        	*
    from payment_detail
    where dt=&#39;2020-06-14&#39;
)pd
on od.id=pd.order_detail_id;  
</code></pre>
<h6 id="Bucket-Map-Join优化前"><a href="#Bucket-Map-Join优化前" class="headerlink" title="Bucket Map Join优化前"></a>Bucket Map Join优化前</h6><pre><code>set hive.auto.convert.join=false;  
</code></pre>
<p><img src="/2023/07/31/Hive-on-mr/15.png" alt="Bucket Map Join优化前"></p>
<h6 id="Bucket-Map-Join优化思路"><a href="#Bucket-Map-Join优化思路" class="headerlink" title="Bucket Map Join优化思路"></a>Bucket Map Join优化思路</h6><p>经分析，参与join的两张表，数据量如下  </p>
<p>order_detail	  1176009934（约1122M）<br>payment_detail	  334198480（约319M）  </p>
<p>可以认为是大表join大表，可尝试采用Bucket Map Join优化方案  </p>
<p>首先需要依据源表创建两个分桶表，order_detail建议分16个bucket  </p>
<p>payment_detail建议分8个bucket,注意分桶个数的倍数关系以及分桶字段  </p>
<p>–订单表 </p>
<pre><code>hive (default)&gt; 
drop table if exists order_detail_bucketed;
create table order_detail_bucketed(
id           string comment &#39;订单id&#39;,
user_id      string comment &#39;用户id&#39;,
product_id   string comment &#39;商品id&#39;,
province_id  string comment &#39;省份id&#39;,
create_time  string comment &#39;下单时间&#39;,
product_num  int comment &#39;商品件数&#39;,
total_amount decimal(16, 2) comment &#39;下单金额&#39;
)
clustered by (id) into 16 buckets
row format delimited fields terminated by &#39;\t&#39;;
</code></pre>
<p>–支付表  </p>
<pre><code>hive (default)&gt; 
drop table if exists payment_detail_bucketed;
create table payment_detail_bucketed(
id              string comment &#39;支付id&#39;,
order_detail_id string comment &#39;订单明细id&#39;,
user_id         string comment &#39;用户id&#39;,
payment_time    string comment &#39;支付时间&#39;,
total_amount    decimal(16, 2) comment &#39;支付金额&#39;
)
clustered by (order_detail_id) into 8 buckets
row format delimited fields terminated by &#39;\t&#39;;  
</code></pre>
<p>然后向两个分桶表导入数据。  </p>
<p>–订单表  </p>
<pre><code>hive (default)&gt; 
insert overwrite table order_detail_bucketed
select
id,
user_id,
product_id,
province_id,
create_time,
product_num,
total_amount   
from order_detail
where dt=&#39;2023-07-28&#39;;
</code></pre>
<p>–分桶表  </p>
<pre><code>hive (default)&gt; 
insert overwrite table payment_detail_bucketed
select
id,
order_detail_id,
user_id,
payment_time,
total_amount
from payment_detail
where dt=&#39;2020-07-28&#39;;
</code></pre>
<p>然后设置以下参数：  </p>
<p>–关闭cbo优化，cbo会导致hint信息被忽略，需将如下参数修改为false  </p>
<pre><code>set hive.cbo.enable=false;  
</code></pre>
<p>–map join hint默认会被忽略(因为已经过时)，需将如下参数修改为false  </p>
<pre><code>set hive.ignore.mapjoin.hint=false;  
</code></pre>
<p>–启用bucket map join优化功能,默认不启用，需将如下参数修改为true </p>
<pre><code>set hive.optimize.bucketmapjoin = true;
</code></pre>
<p>最后在重写SQL语句，如下：  </p>
<pre><code>select /*+ mapjoin(pd) */
    *
from order_detail_bucketed od
join payment_detail_bucketed pd on od.id = pd.order_detail_id; 
</code></pre>
<p><img src="/2023/07/31/Hive-on-mr/16.png">  </p>
<p>由于bucket map join和map join的执行计划非常像，如何确定该执行计划是否属于bucket map join ? </p>
<p><img src="/2023/07/31/Hive-on-mr/17.png"></p>
<h4 id="Sort-Merge-Bucket-Map-Join"><a href="#Sort-Merge-Bucket-Map-Join" class="headerlink" title="Sort Merge Bucket Map Join"></a>Sort Merge Bucket Map Join</h4><p>优化说明  </p>
<p>Sort Merge Bucket Map Join有两种触发方式，包括Hint提示和自动转换。Hint提示已过时，不推荐使用。下面是自动转换的相关参数:  </p>
<p>–启动Sort Merge Bucket Map Join优化  </p>
<pre><code>set hive.optimize.bucketmapjoin.sortedmerge=true;  
</code></pre>
<p>–使用自动转换SMB Join  </p>
<pre><code>set hive.auto.convert.sortmerge.join=true;   
</code></pre>
<h5 id="Sort-Merge-Bucket-Map-Join优化案例"><a href="#Sort-Merge-Bucket-Map-Join优化案例" class="headerlink" title="Sort Merge Bucket Map Join优化案例"></a>Sort Merge Bucket Map Join优化案例</h5><pre><code>select
        *
from(
    select
            *
    from order_detail
    where dt=&#39;2020-06-14&#39;
)od
join(
    select
        *
    from payment_detail
    where dt=&#39;2020-06-14&#39;
)pd
on od.id=pd.order_detail_id;  
</code></pre>
<h5 id="Sort-Merge-Bucket-Map-Join优化思路"><a href="#Sort-Merge-Bucket-Map-Join优化思路" class="headerlink" title="Sort Merge Bucket Map Join优化思路"></a>Sort Merge Bucket Map Join优化思路</h5><p>order_detail	1176009934（约1122M）<br>payment_detail	334198480（约319M）</p>
<p>两张表都相对较大，除了可以考虑采用Bucket Map Join算法，还可以考虑SMB Join。相较于Bucket Map Join，SMB Map Join对分桶大小是没有要求的    </p>
<p>首先需要依据源表创建两个的有序的分桶表，order_detail建议分16个bucket，payment_detail建议分8个bucket,注意分桶个数的倍数关系以及分桶字段和排序字段</p>
<p>–订单表  </p>
<pre><code>hive (default)&gt; 
drop table if exists order_detail_sorted_bucketed;
create table order_detail_sorted_bucketed(
id           string comment &#39;订单id&#39;,
user_id      string comment &#39;用户id&#39;,
product_id   string comment &#39;商品id&#39;,
province_id  string comment &#39;省份id&#39;,
create_time  string comment &#39;下单时间&#39;,
product_num  int comment &#39;商品件数&#39;,
total_amount decimal(16, 2) comment &#39;下单金额&#39;
)	
clustered by (id) sorted by(id) into 16 buckets
row format delimited fields terminated by &#39;\t&#39;;
</code></pre>
<p>–支付表  </p>
<pre><code>hive (default)&gt; 
drop table if exists payment_detail_sorted_bucketed;
create table payment_detail_sorted_bucketed(
id              string comment &#39;支付id&#39;,
order_detail_id string comment &#39;订单明细id&#39;,
user_id         string comment &#39;用户id&#39;,
payment_time    string comment &#39;支付时间&#39;,
total_amount    decimal(16, 2) comment &#39;支付金额&#39;
)
clustered by (order_detail_id) sorted by(order_detail_id) into 8 buckets
row format delimited fields terminated by &#39;\t&#39;;  
</code></pre>
<p>然后向两个分桶表导入数据。  </p>
<p>–订单表  </p>
<pre><code>hive (default)&gt; 
insert overwrite table order_detail_sorted_bucketed
select
id,
user_id,
product_id,
province_id,
create_time,
product_num,
total_amount   
from order_detail
where dt=&#39;2023-07-28&#39;;
</code></pre>
<p>–分桶表  </p>
<pre><code>hive (default)&gt; 
insert overwrite table payment_detail_sorted_bucketed
select
id,
order_detail_id,
user_id,
payment_time,
total_amount
from payment_detail
where dt=&#39;2023-07-28&#39;;  
</code></pre>
<p>–启动Sort Merge Bucket Map Join优化  </p>
<pre><code>set hive.optimize.bucketmapjoin.sortedmerge=true;  
</code></pre>
<p>–使用自动转换SMB Join  </p>
<pre><code>set hive.auto.convert.sortmerge.join=true; 
</code></pre>
<p>最后在重写SQL语句，如下：  </p>
<pre><code>hive (default)&gt; 
select
    *
from order_detail_sorted_bucketed od
join payment_detail_sorted_bucketed pd
on od.id = pd.order_detail_id;  
</code></pre>
<p><img src="/2023/07/31/Hive-on-mr/18.png">  </p>
<h3 id="HQL语法优化之数据倾斜"><a href="#HQL语法优化之数据倾斜" class="headerlink" title="HQL语法优化之数据倾斜"></a>HQL语法优化之数据倾斜</h3><p>数据倾斜概述</p>
<p>数据倾斜问题，通常是指参与计算的数据分布不均，即某个key或者某些key的数据量远超其他key，导致在shuffle阶段，大量相同key的数据被发往同一个Reduce，进而导致该Reduce所需的时间远超其他Reduce，成为整个任务的瓶颈</p>
<p>Hive中的数据倾斜常出现在<strong>分组聚合</strong>和<strong>join操作</strong>的场景中  </p>
<h4 id="分组聚合导致的数据倾斜-（Map-Side聚合-Skew-GroupBy优化）"><a href="#分组聚合导致的数据倾斜-（Map-Side聚合-Skew-GroupBy优化）" class="headerlink" title="分组聚合导致的数据倾斜 （Map-Side聚合&#x2F;Skew-GroupBy优化）"></a>分组聚合导致的数据倾斜 （Map-Side聚合&#x2F;Skew-GroupBy优化）</h4><p>如果group by分组字段的值分布不均，就可能导致大量相同的key进入同一Reduce，从而导致数据倾斜问题   </p>
<p>由分组聚合导致的数据倾斜问题，有以下两种解决思路    </p>
<h5 id="Map-Side聚合"><a href="#Map-Side聚合" class="headerlink" title="Map-Side聚合"></a>Map-Side聚合</h5><p>开启Map-Side聚合后，数据会现在Map端完成部分聚合工作。这样一来即便原始数据是倾斜的，经过Map端的初步聚合后，发往Reduce的数据也就不再倾斜了，最佳状态下，Map-端聚合能完全屏蔽数据倾斜问题。  </p>
<p>相关参数如下：  </p>
<pre><code>set hive.map.aggr=true;

set hive.map.aggr.hash.min.reduction=0.5;  

set hive.groupby.mapaggr.checkinterval=100000;  

set hive.map.aggr.hash.force.flush.memory.threshold=0.9;   
</code></pre>
<h5 id="Skew-GroupBy优化"><a href="#Skew-GroupBy优化" class="headerlink" title="Skew-GroupBy优化"></a>Skew-GroupBy优化</h5><p>Skew-GroupBy的原理是启动两个MR任务，第一个MR按照随机数分区，将数据分散发送到Reduce，完成部分聚合，第二个MR按照分组字段分区，完成最终聚合  </p>
<p>–启用分组聚合数据倾斜优化  </p>
<pre><code>set hive.groupby.skewindata=true;  
</code></pre>
<p>–关闭map-side聚合  </p>
<pre><code>set hive.map.aggr=false;    
</code></pre>
<h4 id="Join导致的数据倾斜"><a href="#Join导致的数据倾斜" class="headerlink" title="Join导致的数据倾斜"></a>Join导致的数据倾斜</h4><p>如果关联字段的值分布不均，就可能导致大量相同的key进入同一Reduce，从而导致数据倾斜问题。  </p>
<p>由join导致的数据倾斜问题，有如下三种解决方案：<br>map join<br>skew join<br>调整sql，通过sql语句将倾斜数据打散成更小的块  </p>
<h5 id="map-join（适用于大表join小表时发生数据倾斜的场景）"><a href="#map-join（适用于大表join小表时发生数据倾斜的场景）" class="headerlink" title="map join（适用于大表join小表时发生数据倾斜的场景）"></a>map join（<strong>适用于大表join小表时发生数据倾斜的场景</strong>）</h5><p> 使用map join算法，join操作仅在map端就能完成，没有shuffle操作，没有reduce阶段，自然不会产生reduce端的数据倾斜     </p>
<p>相关参数参照上文中map join部分内容  </p>
<pre><code>set hive.auto.convert.join=true;  
set hive.mapjoin.smalltable.filesize=250000;  
set hive.auto.convert.join.noconditionaltask=true;
set hive.auto.convert.join.noconditionaltask.size=10000000;
</code></pre>
<h5 id="skew-join（对两表中倾斜的key的数据量有要求）"><a href="#skew-join（对两表中倾斜的key的数据量有要求）" class="headerlink" title="skew join（对两表中倾斜的key的数据量有要求）"></a>skew join（<strong>对两表中倾斜的key的数据量有要求</strong>）</h5><p>skew join的原理是，为倾斜的大key单独启动一个map join任务进行计算，其余key进行正常的common join  </p>
<p><img src="/2023/07/31/Hive-on-mr/19.png" alt="Skew Join原理图">  </p>
<p>相关参数如下：  </p>
<p>–启用skew join优化  </p>
<pre><code>set hive.optimize.skewjoin=true;  
</code></pre>
<p>–触发skew join的阈值，若某个key的行数超过该参数值，则触发  </p>
<pre><code>set hive.skewjoin.key=100000;    
</code></pre>
<p>对两表中倾斜的key的数据量有要求，要求一张表中的倾斜key的数据量比较小（方便走mapjoin）  </p>
<h5 id="SQL打散"><a href="#SQL打散" class="headerlink" title="SQL打散"></a>SQL打散</h5><pre><code>select
    *
from(
    select --打散操作
    concat(id,&#39;_&#39;,cast(rand()*2 as int)) id,
    value
from A
)ta
join(
    select --扩容操作
        concat(id,&#39;_&#39;,0) id,
        value
    from B
    union all
    select
        concat(id,&#39;_&#39;,1) id,
           value
    from B
)tb
on ta.id=tb.id;  
</code></pre>
<p><img src="/2023/07/31/Hive-on-mr/20.png" alt="SQL打散"></p>
<h4 id="HQL语法优化之任务并行度"><a href="#HQL语法优化之任务并行度" class="headerlink" title="HQL语法优化之任务并行度"></a>HQL语法优化之任务并行度</h4><p>对于一个分布式的计算任务而言，设置一个合适的并行度十分重要。Hive的计算任务由MapReduce完成，故并行度的调整需要分为Map端和Reduce端</p>
<h5 id="Map端并行度"><a href="#Map端并行度" class="headerlink" title="Map端并行度"></a>Map端并行度</h5><p>Map端的并行度，也就是Map的个数。是由输入文件的切片数决定的。一般情况下，Map端的并行度无需手动调整  </p>
<p>以下特殊情况可考虑调整map端并行度：  </p>
<p>1）查询的表中存在大量小文件    </p>
<pre><code>set hive.input.format=org.apache.hadoop.hive.ql.io.CombineHiveInputFormat;  
</code></pre>
<p>2）map端有复杂的查询逻辑  </p>
<p>在计算资源充足的情况下，可考虑增大map端的并行度，令map task多一些，每个map task计算的数据少一些  </p>
<p>–一个切片的最大值  </p>
<pre><code>set mapreduce.input.fileinputformat.split.maxsize=256000000;  
</code></pre>
<h5 id="Reduce端并行度"><a href="#Reduce端并行度" class="headerlink" title="Reduce端并行度"></a>Reduce端并行度</h5><p>Reduce端的并行度，也就是Reduce个数。相对来说，更需要关注。Reduce端的并行度，可由用户自己指定，也可由Hive自行根据该MR Job输入的文件大小进行估算    </p>
<p>Reduce端的并行度的相关参数如下：  </p>
<p>–指定Reduce端并行度，默认值为-1，表示用户未指定  </p>
<pre><code>set mapreduce.job.reduces;  
</code></pre>
<p>–Reduce端并行度最大值  </p>
<pre><code>set hive.exec.reducers.max;  
</code></pre>
<p>–单个Reduce Task计算的数据量，用于估算Reduce并行度  </p>
<pre><code>set hive.exec.reducers.bytes.per.reducer;
</code></pre>
<h6 id="估算逻辑"><a href="#估算逻辑" class="headerlink" title="估算逻辑"></a>估算逻辑</h6><p>假设Job输入的文件大小为totalInputBytes  </p>
<p>参数hive.exec.reducers.bytes.per.reducer的值为bytesPerReducer。  </p>
<p>参数hive.exec.reducers.max的值为maxReducers。  </p>
<p>则Reduce端的并行度为：  </p>
<pre><code>min(ceil(totalInputBytes/bytesPerReducer),maxReducers)  
</code></pre>
<h4 id="HQL语法优化之小文件合并"><a href="#HQL语法优化之小文件合并" class="headerlink" title="HQL语法优化之小文件合并"></a>HQL语法优化之小文件合并</h4><p>Map端输入文件合并   </p>
<p>合并Map端输入的小文件，是指将多个小文件划分到一个切片中，进而由一个Map Task去处理。目的是防止为单个小文件启动一个Map Task，浪费计算资源  </p>
<p>–可将多个小文件切片，合并为一个切片，进而由一个map任务处理  </p>
<pre><code>set hive.input.format=org.apache.hadoop.hive.ql.io.CombineHiveInputFormat;  
</code></pre>
<p>Reduce输出文件合并  </p>
<p>合并Reduce端输出的小文件，是指将多个小文件合并成大文件。目的是减少HDFS小文件数量。其原理是根据计算任务输出文件的平均大小进行判断，若符合条件，则单独启动一个额外的任务进行合并  </p>
<p>–开启合并map only任务输出的小文件  </p>
<pre><code>set hive.merge.mapfiles=true;
</code></pre>
<p>–开启合并map reduce任务输出的小文件  </p>
<pre><code>set hive.merge.mapredfiles=true;
</code></pre>
<p>–合并后的文件大小</p>
<pre><code>set hive.merge.size.per.task=256000000;
</code></pre>
<p>–触发小文件合并任务的阈值，若某计算任务输出的文件平均大小低于该值，则触发合并 </p>
<pre><code>set hive.merge.smallfiles.avgsize=16000000;  
</code></pre>
<h3 id="其他优化"><a href="#其他优化" class="headerlink" title="其他优化"></a>其他优化</h3><h4 id="1-CBO优化"><a href="#1-CBO优化" class="headerlink" title="1.CBO优化"></a>1.CBO优化</h4><p>CBO是指Cost based Optimizer，即基于计算成本的优化</p>
<p>在Hive中，计算成本模型考虑到了：数据的行数、CPU、本地IO、HDFS IO、网络IO等方面  </p>
<p>目前CBO在hive的MR引擎下主要用于join的优化，例如多表join的join顺序  </p>
<p>–是否启用cbo优化   </p>
<pre><code>set hive.cbo.enable=true;    
</code></pre>
<h4 id="2-谓词下推"><a href="#2-谓词下推" class="headerlink" title="2.谓词下推"></a>2.谓词下推</h4><p>谓词下推（predicate pushdown）是指，尽量将过滤操作前移，以减少后续计算步骤的数据量</p>
<p>–是否启动谓词下推（predicate pushdown）优化  </p>
<pre><code>set hive.optimize.ppd = true;  
</code></pre>
<p>CBO优化也会完成一部分的谓词下推优化工作，因为在执行计划中，谓词越靠前，整个计划的计算成本就会越低</p>
<h4 id="3-矢量化查询"><a href="#3-矢量化查询" class="headerlink" title="3.矢量化查询"></a>3.矢量化查询</h4><p>Hive的矢量化查询优化，依赖于CPU的矢量化计算，CPU的矢量化计算的基本原理如下图  </p>
<p><img src="/2023/07/31/Hive-on-mr/21.png" alt="矢量化计算原理">  </p>
<pre><code>set hive.vectorized.execution.enabled=true;  
</code></pre>
<p>若执行计划中，出现“Execution mode: vectorized”字样，即表明使用了矢量化计算。  </p>
<p><a target="_blank" rel="noopener" href="https://cwiki.apache.org/confluence/display/Hive/Vectorized+Query+Execution#VectorizedQueryExecution-Limitations">矢量化计算官方文档</a> </p>
<h4 id="4-Fetch抓取"><a href="#4-Fetch抓取" class="headerlink" title="4.Fetch抓取"></a>4.Fetch抓取</h4><p>Fetch抓取是指，Hive中对某些情况的查询可以不必使用MapReduce计算  </p>
<p>Hive可以简单地读取emp对应的存储目录下的文件，然后输出查询结果到控制台</p>
<p>–是否在特定场景转换为fetch 任务  </p>
<p>–设置为none表示不转换  </p>
<p>–设置为minimal表示支持select *，分区字段过滤，Limit等  </p>
<p>–设置为more表示支持select 任意字段,包括函数，过滤，和limit等  </p>
<pre><code>set hive.fetch.task.conversion=more;  
</code></pre>
<h4 id="5-本地模式（不上yarn）"><a href="#5-本地模式（不上yarn）" class="headerlink" title="5.本地模式（不上yarn）"></a>5.本地模式（不上yarn）</h4><p>Hive可以通过本地模式在单台机器上处理所有的任务。对于小数据集，执行时间可以明显被缩短</p>
<p>–开启自动转换为本地模式  </p>
<pre><code>set hive.exec.mode.local.auto=true;  
</code></pre>
<p>–设置local MapReduce的最大输入数据量，当输入数据量小于这个值时采用local  MapReduce的方式，默认为134217728，即128M  </p>
<pre><code>set hive.exec.mode.local.auto.inputbytes.max=50000000;
</code></pre>
<p>–设置local MapReduce的最大输入文件个数，当输入文件个数小于这个值时采用local MapReduce的方式，默认为4  </p>
<pre><code>set hive.exec.mode.local.auto.input.files.max=10;
</code></pre>
<h4 id="6-并行执行"><a href="#6-并行执行" class="headerlink" title="6.并行执行"></a>6.并行执行</h4><p>Hive会将一个SQL语句转化成一个或者多个Stage，每个Stage对应一个MR Job。默认情况下，Hive同时只会执行一个Stage。但是某SQL语句可能会包含多个Stage，但这多个Stage可能并非完全互相依赖，也就是说有些Stage是可以并行执行的。此处提到的并行执行就是指这些Stage的并行执行   </p>
<p>–启用并行执行优化  </p>
<pre><code>set hive.exec.parallel=true;       
</code></pre>
<p>–同一个sql允许最大并行度，默认为8  </p>
<pre><code>set hive.exec.parallel.thread.number=8;   
</code></pre>
<h4 id="7-严格模式"><a href="#7-严格模式" class="headerlink" title="7.严格模式"></a>7.严格模式</h4><p>Hive可以通过设置某些参数防止危险操作：   </p>
<p>1）分区表不使用分区过滤  </p>
<p>将hive.strict.checks.no.partition.filter设置为true时，对于分区表，除非where语句中含有分区字段过滤条件来限制范围，否则不允许执行  </p>
<p>2）使用order by没有limit过滤   </p>
<p>将hive.strict.checks.orderby.no.limit设置为true时，对于使用了order by语句的查询，要求必须使用limit语句    </p>
<p>3）笛卡尔积    </p>
<p>将hive.strict.checks.cartesian.product设置为true时，会限制笛卡尔积的查询</p>

    </div>

    
    
    
	
	  <div>
		<div>
    
        <div style="text-align:center;color: #ccc;font-size:24px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>
	  </div>
	
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>张宴银
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://example.com/2023/07/31/Hive-on-mr/" title="Hive on mr调优">http://example.com/2023/07/31/Hive-on-mr/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
        </div>
    </div>
  </div>



      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E6%88%91%E4%BA%8E%E4%BA%BA%E9%97%B4%E5%85%A8%E6%97%A0%E6%95%8C%EF%BC%8C%E4%B8%8D%E4%B8%8E%E5%A4%A9%E6%88%98%E4%B8%8E%E8%B0%81%E6%88%98%EF%BC%9F/" rel="tag"># 我于人间全无敌，不与天战与谁战？</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/07/31/hive-udf/" rel="prev" title="hive-udf">
      <i class="fa fa-chevron-left"></i> hive-udf
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/08/01/SQLServer%E6%9F%A5%E8%AF%A2%E4%BD%93%E7%B3%BB%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" rel="next" title="SQLServer查询体系学习记录">
      SQLServer查询体系学习记录 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">
      <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=2042878838&auto=1&height=66"></iframe>

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%88%91%E4%BA%8E%E4%BA%BA%E9%97%B4%E5%85%A8%E6%97%A0%E6%95%8C%EF%BC%8C%E4%B8%8D%E4%B8%8E%E5%A4%A9%E6%88%98%E4%B8%8Eshui%E6%88%98%EF%BC%9F"><span class="nav-number">1.</span> <span class="nav-text">我于人间全无敌，不与天战与shui战？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%BB%84%E4%BB%B6%E8%B5%84%E6%BA%90%E8%B0%83%E4%BC%98"><span class="nav-number">1.1.</span> <span class="nav-text">1:组件资源调优</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Yarn%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE"><span class="nav-number">1.1.1.</span> <span class="nav-text">Yarn资源配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MapReduce%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE"><span class="nav-number">1.1.2.</span> <span class="nav-text">MapReduce资源配置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-Explain%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E8%B0%83%E4%BC%98"><span class="nav-number">2.</span> <span class="nav-text">2.Explain执行计划调优</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E7%94%A8%E8%A1%A8"><span class="nav-number">2.1.</span> <span class="nav-text">测试用表</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E8%AE%A2%E5%8D%95%E8%A1%A8-2000w%E6%9D%A1%E6%95%B0%E6%8D%AE"><span class="nav-number">2.1.1.</span> <span class="nav-text">1.订单表(2000w条数据)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BB%BA%E8%A1%A8%E8%AF%AD%E5%8F%A5"><span class="nav-number">2.1.1.1.</span> <span class="nav-text">建表语句</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E8%A3%85%E8%BD%BD"><span class="nav-number">2.1.1.2.</span> <span class="nav-text">数据装载</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%94%AF%E4%BB%98%E8%A1%A8-600w%E6%9D%A1%E6%95%B0%E6%8D%AE"><span class="nav-number">2.1.2.</span> <span class="nav-text">2.支付表(600w条数据)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BB%BA%E8%A1%A8%E8%AF%AD%E5%8F%A5-1"><span class="nav-number">2.1.2.1.</span> <span class="nav-text">建表语句</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E8%A3%85%E8%BD%BD-1"><span class="nav-number">2.1.2.2.</span> <span class="nav-text">数据装载</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%95%86%E5%93%81%E4%BF%A1%E6%81%AF%E8%A1%A8-100w%E6%9D%A1%E6%95%B0%E6%8D%AE"><span class="nav-number">2.1.3.</span> <span class="nav-text">3.商品信息表(100w条数据)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BB%BA%E8%A1%A8%E8%AF%AD%E5%8F%A5-2"><span class="nav-number">2.1.3.1.</span> <span class="nav-text">建表语句</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E8%A3%85%E8%BD%BD-2"><span class="nav-number">2.1.3.2.</span> <span class="nav-text">数据装载</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E7%9C%81%E4%BB%BD%E4%BF%A1%E6%81%AF%E8%A1%A8-34%E6%9D%A1%E6%95%B0%E6%8D%AE"><span class="nav-number">2.1.4.</span> <span class="nav-text">4.省份信息表(34条数据)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BB%BA%E8%A1%A8%E8%AF%AD%E5%8F%A5-3"><span class="nav-number">2.1.4.1.</span> <span class="nav-text">建表语句</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E8%A3%85%E8%BD%BD-3"><span class="nav-number">2.1.4.2.</span> <span class="nav-text">数据装载</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Explain%E6%9F%A5%E7%9C%8B%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%EF%BC%88%E9%87%8D%E7%82%B9%EF%BC%89"><span class="nav-number">2.2.</span> <span class="nav-text">Explain查看执行计划（重点）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84Operator%E5%8F%8A%E5%85%B6%E4%BD%9C%E7%94%A8%E5%A6%82%E4%B8%8B%EF%BC%9A"><span class="nav-number">2.2.1.</span> <span class="nav-text">常见的Operator及其作用如下：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Explain%E6%9F%A5%E7%9C%8B%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="nav-number">2.2.2.</span> <span class="nav-text">Explain查看执行计划基本语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Explain%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E5%8F%AF%E8%A7%86%E5%8C%96%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="nav-number">2.2.3.</span> <span class="nav-text">Explain执行计划可视化工具使用方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HQL%E8%AF%AD%E6%B3%95%E4%BC%98%E5%8C%96%E4%B9%8B%E5%88%86%E7%BB%84%E8%81%9A%E5%90%88%E4%BC%98%E5%8C%96-%EF%BC%88map-site%EF%BC%89"><span class="nav-number">2.3.</span> <span class="nav-text">HQL语法优化之分组聚合优化 （map-site）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#map-side-%E8%81%9A%E5%90%88%E7%9B%B8%E5%85%B3%E7%9A%84%E5%8F%82%E6%95%B0%E5%A6%82%E4%B8%8B%EF%BC%9A"><span class="nav-number">2.3.1.</span> <span class="nav-text">map-side 聚合相关的参数如下：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HQL%E8%AF%AD%E6%B3%95%E4%BC%98%E5%8C%96%E4%B9%8B%E5%88%86%E7%BB%84%E8%81%9A%E5%90%88%E4%BC%98%E5%8C%96-%EF%BC%88map-site%EF%BC%89%E4%BC%98%E5%8C%96%E6%A1%88%E4%BE%8B"><span class="nav-number">2.3.2.</span> <span class="nav-text">HQL语法优化之分组聚合优化 （map-site）优化案例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%98%E5%8C%96%E6%80%9D%E8%B7%AF"><span class="nav-number">2.3.2.1.</span> <span class="nav-text">优化思路</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HQL%E8%AF%AD%E6%B3%95%E4%BC%98%E5%8C%96%E4%B9%8BJoin%E4%BC%98%E5%8C%96"><span class="nav-number">2.3.3.</span> <span class="nav-text">HQL语法优化之Join优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Map-Join"><span class="nav-number">2.3.3.1.</span> <span class="nav-text">Map Join</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Map-Join%E4%BC%98%E5%8C%96%E6%A1%88%E4%BE%8B"><span class="nav-number">2.3.3.1.1.</span> <span class="nav-text">Map Join优化案例</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Map-Join%E6%96%B9%E6%A1%88%E4%B8%80%EF%BC%9A"><span class="nav-number">2.3.3.1.1.1.</span> <span class="nav-text">Map Join方案一：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Map-Join%E6%96%B9%E6%A1%88%E4%BA%8C%EF%BC%9A"><span class="nav-number">2.3.3.1.1.2.</span> <span class="nav-text">Map Join方案二：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Map-Join%E6%96%B9%E6%A1%88%E4%B8%89%EF%BC%9A"><span class="nav-number">2.3.3.1.1.3.</span> <span class="nav-text">Map Join方案三：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Bucket-Map-Join"><span class="nav-number">2.3.3.2.</span> <span class="nav-text">Bucket Map Join</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Bucket-Map-Join%E4%BC%98%E5%8C%96%E6%A1%88%E4%BE%8B"><span class="nav-number">2.3.3.2.1.</span> <span class="nav-text">Bucket Map Join优化案例</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Bucket-Map-Join%E4%BC%98%E5%8C%96%E5%89%8D"><span class="nav-number">2.3.3.2.1.1.</span> <span class="nav-text">Bucket Map Join优化前</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Bucket-Map-Join%E4%BC%98%E5%8C%96%E6%80%9D%E8%B7%AF"><span class="nav-number">2.3.3.2.1.2.</span> <span class="nav-text">Bucket Map Join优化思路</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Sort-Merge-Bucket-Map-Join"><span class="nav-number">2.3.3.3.</span> <span class="nav-text">Sort Merge Bucket Map Join</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Sort-Merge-Bucket-Map-Join%E4%BC%98%E5%8C%96%E6%A1%88%E4%BE%8B"><span class="nav-number">2.3.3.3.1.</span> <span class="nav-text">Sort Merge Bucket Map Join优化案例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Sort-Merge-Bucket-Map-Join%E4%BC%98%E5%8C%96%E6%80%9D%E8%B7%AF"><span class="nav-number">2.3.3.3.2.</span> <span class="nav-text">Sort Merge Bucket Map Join优化思路</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HQL%E8%AF%AD%E6%B3%95%E4%BC%98%E5%8C%96%E4%B9%8B%E6%95%B0%E6%8D%AE%E5%80%BE%E6%96%9C"><span class="nav-number">2.3.4.</span> <span class="nav-text">HQL语法优化之数据倾斜</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E7%BB%84%E8%81%9A%E5%90%88%E5%AF%BC%E8%87%B4%E7%9A%84%E6%95%B0%E6%8D%AE%E5%80%BE%E6%96%9C-%EF%BC%88Map-Side%E8%81%9A%E5%90%88-Skew-GroupBy%E4%BC%98%E5%8C%96%EF%BC%89"><span class="nav-number">2.3.4.1.</span> <span class="nav-text">分组聚合导致的数据倾斜 （Map-Side聚合&#x2F;Skew-GroupBy优化）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Map-Side%E8%81%9A%E5%90%88"><span class="nav-number">2.3.4.1.1.</span> <span class="nav-text">Map-Side聚合</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Skew-GroupBy%E4%BC%98%E5%8C%96"><span class="nav-number">2.3.4.1.2.</span> <span class="nav-text">Skew-GroupBy优化</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Join%E5%AF%BC%E8%87%B4%E7%9A%84%E6%95%B0%E6%8D%AE%E5%80%BE%E6%96%9C"><span class="nav-number">2.3.4.2.</span> <span class="nav-text">Join导致的数据倾斜</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#map-join%EF%BC%88%E9%80%82%E7%94%A8%E4%BA%8E%E5%A4%A7%E8%A1%A8join%E5%B0%8F%E8%A1%A8%E6%97%B6%E5%8F%91%E7%94%9F%E6%95%B0%E6%8D%AE%E5%80%BE%E6%96%9C%E7%9A%84%E5%9C%BA%E6%99%AF%EF%BC%89"><span class="nav-number">2.3.4.2.1.</span> <span class="nav-text">map join（适用于大表join小表时发生数据倾斜的场景）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#skew-join%EF%BC%88%E5%AF%B9%E4%B8%A4%E8%A1%A8%E4%B8%AD%E5%80%BE%E6%96%9C%E7%9A%84key%E7%9A%84%E6%95%B0%E6%8D%AE%E9%87%8F%E6%9C%89%E8%A6%81%E6%B1%82%EF%BC%89"><span class="nav-number">2.3.4.2.2.</span> <span class="nav-text">skew join（对两表中倾斜的key的数据量有要求）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SQL%E6%89%93%E6%95%A3"><span class="nav-number">2.3.4.2.3.</span> <span class="nav-text">SQL打散</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#HQL%E8%AF%AD%E6%B3%95%E4%BC%98%E5%8C%96%E4%B9%8B%E4%BB%BB%E5%8A%A1%E5%B9%B6%E8%A1%8C%E5%BA%A6"><span class="nav-number">2.3.4.3.</span> <span class="nav-text">HQL语法优化之任务并行度</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Map%E7%AB%AF%E5%B9%B6%E8%A1%8C%E5%BA%A6"><span class="nav-number">2.3.4.3.1.</span> <span class="nav-text">Map端并行度</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Reduce%E7%AB%AF%E5%B9%B6%E8%A1%8C%E5%BA%A6"><span class="nav-number">2.3.4.3.2.</span> <span class="nav-text">Reduce端并行度</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%BC%B0%E7%AE%97%E9%80%BB%E8%BE%91"><span class="nav-number">2.3.4.3.2.1.</span> <span class="nav-text">估算逻辑</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#HQL%E8%AF%AD%E6%B3%95%E4%BC%98%E5%8C%96%E4%B9%8B%E5%B0%8F%E6%96%87%E4%BB%B6%E5%90%88%E5%B9%B6"><span class="nav-number">2.3.4.4.</span> <span class="nav-text">HQL语法优化之小文件合并</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E4%BC%98%E5%8C%96"><span class="nav-number">2.3.5.</span> <span class="nav-text">其他优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-CBO%E4%BC%98%E5%8C%96"><span class="nav-number">2.3.5.1.</span> <span class="nav-text">1.CBO优化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E8%B0%93%E8%AF%8D%E4%B8%8B%E6%8E%A8"><span class="nav-number">2.3.5.2.</span> <span class="nav-text">2.谓词下推</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E7%9F%A2%E9%87%8F%E5%8C%96%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.3.5.3.</span> <span class="nav-text">3.矢量化查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-Fetch%E6%8A%93%E5%8F%96"><span class="nav-number">2.3.5.4.</span> <span class="nav-text">4.Fetch抓取</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-%E6%9C%AC%E5%9C%B0%E6%A8%A1%E5%BC%8F%EF%BC%88%E4%B8%8D%E4%B8%8Ayarn%EF%BC%89"><span class="nav-number">2.3.5.5.</span> <span class="nav-text">5.本地模式（不上yarn）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-%E5%B9%B6%E8%A1%8C%E6%89%A7%E8%A1%8C"><span class="nav-number">2.3.5.6.</span> <span class="nav-text">6.并行执行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-%E4%B8%A5%E6%A0%BC%E6%A8%A1%E5%BC%8F"><span class="nav-number">2.3.5.7.</span> <span class="nav-text">7.严格模式</span></a></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="张宴银"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">张宴银</p>
  <div class="site-description" itemprop="description">初级以内我无敌，中级以上我一换一</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">18</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; Sat Jul 29 2023 08:00:00 GMT+0800 (中国标准时间) – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张宴银</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>



    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <span id="busuanzi_container_site_pv">总访问量<span id="busuanzi_value_site_pv"></span>次</span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_uv">总访客数<span id="busuanzi_value_site_uv"></span>人</span>
    <span class="post-meta-divider">|</span>
<!-- 不蒜子计数初始值纠正 -->
<script>
$(document).ready(function() {

    var int = setInterval(fixCount, 50);  // 50ms周期检测函数
    var countOffset = 20000;  // 初始化首次数据

    function fixCount() {            
       if (document.getElementById("busuanzi_container_site_pv").style.display != "none")
        {
            $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + countOffset); 
            clearInterval(int);
        }                  
        if ($("#busuanzi_container_site_pv").css("display") != "none")
        {
            $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + countOffset); // 加上初始数据 
            clearInterval(int); // 停止检测
        }  
    }
       	
});
</script> 


<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共49.7k字</span>
</div>
        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>


  <script defer src="/lib/three/three.min.js"></script>
    <script defer src="/lib/three/canvas_lines.min.js"></script>


  




  
<script src="/js/local-search.js"></script>













  

  

  

</body>
</html>
